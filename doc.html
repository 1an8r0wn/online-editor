<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="./app.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/store@2.0.12/dist/store.legacy.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
    <title>Doc LIST | online text editor</title>
</head>

<body>
    <div class="max-w-screen-sm mx-auto min-h-screen p-1">
        <div class="py-2 flex items-center justify-between sticky top-0 bg-white">
            <a href="/doclist.html" class="btn btn-outline btn-sm">
                back
            </a>
            <div class="flex items-center">
                <button id="save-btn" class="btn btn-primary btn-sm mr-2">
                    save
                </button>
                <!-- <button id="more-btn" class="btn btn-outline btn-sm">
                    more
                </button> -->
            </div>
        </div>
        <div id="more" class="bg-green-50 p-4 text-2xs hidden ">
            <div>
                <div>Editable URL:
                    <span id="editable-url"></span>

                </div>
                <div>Share Code:
                    [<span class="text-red-500" id="editable-code"></span>]
                </div>
            </div>
            <!-- <div class="mt-2">
                <div>ViewOnly URL:
                    <span id="view-url"></span>
                </div>
            </div> -->
        </div>
        <div id="loading" class="p-20">
            <svg class="text-blue-500 animate-spin  mx-auto h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
        </div>
        <textarea id="doc-textarea" data-expandable placeholder="write here ..."
            class="hidden resize-none border border-gray-200 min-h-16 w-full bg-gray-50 text-sm p-2 mt-2 text-black focus:outline-none"></textarea>
    </div>
    <script>

        toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": false,
            "progressBar": false,
            "positionClass": "toast-bottom-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }


        let id = new URLSearchParams(location.search).get('id');
        $('#set-btn').attr('href', 'setting.html?id=' + id);
        let $textarea = $('#doc-textarea');
        let $saveBtn = $('#save-btn')
        $saveBtn.on('click', function () {
            if ($saveBtn.hasClass('loading')) {
                return
            };
            $saveBtn.addClass('loading');
            $.post('/api/doc-save', { id: id, content: $('#doc-textarea').val() }, function (data) {
                $saveBtn.removeClass('loading');
            })
        });

        $(function () {
            $saveBtn.addClass('loading').text('')
            $.get('/api/doc-get?id=' + id, function (doc) {
                $('#editable-url').text('https://doc.op52.com/doc.html?id=' + doc.id)
                $('#editable-code').text(doc.code.no)
                $('#view-url').text('https://doc.op52.com/doc.html?vid=' + doc.vid)
                $('#loading').hide();
                $('#more').show();
                $textarea.show().val(doc.content);
                $textarea[0].style.removeProperty('height');
                $textarea[0].style.height = ($textarea[0].scrollHeight + 2) + 'px';
                $saveBtn.removeClass('loading').text('save')
                let list = store.get('doc-list');
                list = list ? JSON.parse(list) : [];

                let filtered = list.filter(function (i) {
                    return i.id == id
                });
                if (filtered.length == 0) {
                    list.push(doc)
                    store.set('doc-list', JSON.stringify(list));
                }

                store.set('doc-' + id, doc);

                toastr["info"]("save successful")
            })
        });
        $('body').on('keydown input', 'textarea[data-expandable]', function () {
            //Auto-expanding textarea
            this.style.removeProperty('height');
            this.style.height = (this.scrollHeight + 2) + 'px';
        }).on('mousedown focus', 'textarea[data-expandable]', function () {
            //Do this on focus, to allow textarea to animate to height...
            this.style.removeProperty('height');
            this.style.height = (this.scrollHeight + 2) + 'px';
        });
    </script>
</body>

</html>